<!--@author Rasmus Pedersen-->
<html>
<head>
<title>NXTMOTE Tutorial Lesson A: Toolchain</title>
<link href="../../stylesheets/tutorial.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="title">Lesson A: NXTMOTE Toolchain</div>
<div class="subtitle">Last updated May 16 2007</div>
<h1>Introduction</h1>
<p>This lesson describe the steps that are involved when setting up the TinyOS 2.0 toolchain for nxtmote. Nxtmote is runs on an ARM MCU. Accordingly, it is necessary to install the ARM toolchain on your PC. There are good commercial compilers available, but in this tutorial the open source compiler gcc is used. Upon successful installation, we end up with a compiler that can be invoked with <code>arm-elf-gcc</code> from the command line.</p>

<h1>Prerequisite: Install TinyOS Environment</h1>
As a prerequiThe TinyOS 2.0 build environment needs to be installed. There is a good description available, which is named <a href="http://www.tinyos.net/tinyos-2.x/doc/html/install-tinyos.html">Installing TinyOS 2.0</a>. Step 3 in that documentation concerns the native compilers. It can be skipped because we just need the compiler for the arm target.

<h1>GCC</h1>

<p>The gcc compiler is invoked by the nesc compiler and produces the binary image of the application to be programmed on the target. The TinyOS <a href="http://www.tinyos.net/tinyos-2.x/doc/html/install-tinyos.html">installation procedure</a> describes how to install RPM files. To use the RPM files below is one option; another option is to use the RPM spec files to compile your own RPM files. Both steps are lined out below.</p>

<h2>Arm-elf-gcc RPMs</h2>
<p>The rpm files that contain the binary arm-elf binutils and gcc compiler are listed in the table below. Each package is installed with the rpm command as explained below the table.</p>

<!----- ARM-ELF external tools -------->
</p><p><b><em>Atmel ARM Tools</em></b>
<table border="0">
<tbody><tr>
  <td bgcolor="#dddddd"><b>Tool</b></td>
  <td bgcolor="#dddddd"><b>Windows/Cygwin</b></td>
  <td bgcolor="#dddddd"><b>Linux</b></td>
</tr>
<tr>
  <td>arm-elf-binutils</td>
  <td><a href="http://www.tinyos.net/dist-2.0.0/tools/windows/avr-binutils-2.15tinyos-3.cygwin.i386.rpm">arm-elf-binutils-2.17-1.cygwin.i386.rpm</a></td>
  <td><a href="http://www.tinyos.net/dist-2.0.0/tools/linux/avr-binutils-2.15tinyos-3.i386.rpm">arm-elf-binutils-2.17-1.i386.rpm</a></td>
</tr>
<tr>
  <td bgcolor="#dddddd">arm-elf-gcc</td>
  <td bgcolor="#dddddd"><a href="http://www.tinyos.net/dist-2.0.0/tools/windows/avr-gcc-3.4.3-1.cygwin.i386.rpm">arm-elf-gcc-4.1.2-1.cygwin.i386.rpm</a></td>
  <td bgcolor="#dddddd"><a href="http://www.tinyos.net/dist-2.0.0/tools/linux/avr-gcc-3.4.3-1.i386.rpm">arm-elf-gcc-4.1.2-1.i386.rpm</a></td>
</tr>
</tbody>
</table>

<p>To install the package we need to use the rpm command:</p>

<pre>
$ wget http://prdownloads.sourceforge.net/nxtmote/arm-elf-gcc-4.1.2-1.cygwin.i386.rpm
$ wget http://prdownloads.sourceforge.net/nxtmote/arm-elf-gcc-4.1.2-1.i386.rpm
$ rpm -Uvh elf-binutils-2.17-1.cygwin.i386.rpm
$ rpm -Uvh arm-elf-gcc-4.1.2-1.i386.rpm
$
</pre>



<h2>Creating the arm-elf RPMs From Scratch</h2>

</p><p><b><em>Atmel ARM RPM Specs</em></b>
<table border="0">
<tbody><tr>
  <td bgcolor="#dddddd"><b>Tool</b></td>
  <td bgcolor="#dddddd"><b>RPM spec file</b></td>
</tr>

<tr>
  <td>arm-elf-binutils</td>
  <td><a href="http://www.tinyos.net/dist-2.0.0/tools/windows/avr-binutils-2.15tinyos-3.cygwin.i386.rpm">arm-elf-binutils.spec</a></td>
</tr>

<tr>
  <td bgcolor="#dddddd">arm-elf-gcc</td>
  <td bgcolor="#dddddd"><a href="http://www.tinyos.net/dist-2.0.0/tools/windows/avr-gcc-3.4.3-1.cygwin.i386.rpm">arm-elf-gcc.spec</a></td>
</tr>
</tbody>
</table>

<p>The RPM...</p>

<h1>Flash Programming</h1>
<p>It is also needed to install tools for programming nxtmote with the compiled program. The previous steps have enabled you to compile nesC code to a binary image. This binary image needs to be moved into the flash memory of nxtmote. Again, there are several choices available. Some choices include commercial tools that use a JTAG emulator to program the flash memory; other tools are platform-specific, which is not what we want here. An open source USB-based program exists to fullfill the flash programming task.</p>

<p>The USB-based flash programmer is called <a href="http://code.google.com/p/libnxt/">libnxt</a>. It includes an utility program for programming the flash memory in nxtmote with the compiled image. To interface with the USB port of the PC we also need to install <a href="http://libusb.sourceforge.net">libusb</a>.</p>

<h2>Installing libusb</h2>
<p>If you are working from a Linux environment these steps will help you to install libusb.</p>

<h2>Installing libusb-win32</h2>
<p>If you are working from a Win32/Cygwin environment the following steps are needed to install libusb-win32. The cygwin installer can be used to fetch the sources for this library. To do this you invoke the <code>setup.exe</code> utility program that came with Cygwin. Select the <code>libusb-win32</code> in the Libs category. Ensure that you check the source checkbox and that the version reads 0.1.12.1-2. Continue with the wizard. Note that other packages may be updated or installed at this point if you have the standard cygwin packages <a href="http://www.tinyos.net/tinyos-2.x/doc/html/install-tinyos.html">installed</a>. We can now verify that the libusb-win32 source is downloaded:</p>

<pre>
$ mkdir libusb-win32-temp
$ cd libusb-win32-temp
$ wget ftp://mirrors.dotsrc.org/mirrors/cygwin/release/libusb-win32/libusb-win32-0.1.12.1-2.tar.bz2
$ bunzip2 <libusb-win32-0.1.12.1-2.tar.bz2  | tar -xvf -
$ cp -r etc usr /
$ cd ..
$ rm -rf libusb-win32-temp
</pre>

<p>Now that the libusb-win32 files are placed correctly in <code>/etc</code> and <code>/usr</code> we can install and configure the UBS connection for nxtmote. Two things must be accomplished: the driver is to be copied to the windows driver directory and the USB filter is to be installed. The USB filter allows it to communicate with nxtmote. It is done like this:</p>

<pre>
$ cd /lib/libusb/
$ ./inf-wizard.exe
</pre>

<p>Now the inf-wizard screen is invoked and it is time to place nxtmote in SAM-BA mode. This is done by pressing the reset button for five seconds. The reset button is located in the hole next to the USB cable and it is accessed down from underneith the device. A clicking sound is a sound is a good sign that nxtmote is placed in SAM-BA mode. In this mode a small bootloader enables flashprogramming of nxtmote. Now contunue to the second screen in the LibUSB-Win32 wizard and select the USB device with vendor id 0x03EB (it is Atmel). Continue with the wizard and enter "LEGO" and "NXTMOTE" in the <i>Manufacturer Name</i> and <i>Device Name</i> fields respectively. Finalize the wizard by saving the inf file as nxtmote.inf.</p>

<p>The USB device driver for nxt was created in the last step. It can now be installed. To do this, remove nxtmote from the USB port again. Then plug in again. Windows should launch the wizard for new hardware found. If this does not happen, then place nxtmote in SAM-BA mode again (see above). Then point the new hardware wizard to the device driver <code>/usr/lib/libusb/nxtmote.inf</code>. The wizard will complain it can not copy libusb0.sys, but actually it does do it when you choose to continue with the wizard and ignore the copy error. At this point the USB driver for nxtmote is installed and ready for use. It can be verified by right-clicking on <i>My Computer</i> and selecting the <i>Device Manager</i> under the <i>Hardware</i> tab. There will an entry called <i>NXTMOTE</i> in the list:</p>
<img src="img/nxtmote-usb.jpg">

<h2>Installing SCons</h2>
<p><a href="http://www.scons.org/">SCons</a> is a make-alike tool written in python. It is used by the libnxt developer to build the firmware flash utility. SCons can be <a href="http://www.scons.org/download.php">downloaded</a> and installed downloaded in many ways. The RPM installation is described below.</p>

<p>To get scons and make it ready for compilation, write:</p>

<pre>
$ cd /usr/src/rpm/SRPMS/
$ wget http://prdownloads.sourceforge.net/scons/scons-0.97-1.src.rpm
$ rpm -i scons-0.97-1.src.rpm
$ cd ../SOURCES/
$ gunzip scons-0.97.tar.gz
$ tar xvf scons-0.97.tar
$ cd scons-0.97/
</pre>

<p><code>rpm</code> rpm command will unpack the source rpm and place the scons tar.gz file in <code>/usr/src/rpm/SOURCES/</code>. Now we can compile the scons sources. When that is done the scons system is ready for installation. Perform these steps:</p>

<pre>
$ python setup.py install
</pre>

<p>That will install the scons system on the PC. It is implied that python is installed before scons (it is a part of the standard <a href="http://www.tinyos.net/tinyos-2.x/doc/html/install-tinyos.html">TinyOS cygwin packages</a>.). The installation can be verified by writing <code>scons -v</code>, which will print the scons version number.</p>

<p>We can also fetch the source for the RPM system and build it manually. Ensure that you have the RPM system installed </p>
<pre></pre>

<h1>Related Documentation</h1>
</a>
<ul>
<li><a href="http://www.atmel.com/dyn/resources/prod_documents/doc6175.pdf">ARM AT91</a>: the comprehensive description of the AT91SAM7S256 MCU from Atmel</li>
<li><a href="http://code.google.com/p/libnxt/">libnxt</a>: utility program for nxtmote flash programming</li>
<li><a href="http://libusb.sourceforge.net">libusb</a> and <a href="http://libusb-win32.sourceforge.net/">libusb-win32</a>: library to access USB devices</li>
<li><a href="http://mindstorms.lego.com/Overview/NXTreme.aspx">LEGO MINDSTORMS NXT</a>: LEGO's open source software and hardware schematics</li>
<li><a href="http://nxtmote.sourceforge.net">nxtmote</a>: additional project information
</ul>

<!-- Begin footer -->
<br>
</p><hr>
<center>
<p>&lt;&nbsp;<b><a href="http://www.tinyos.net/tinyos-2.x/doc/html/tutorial/lesson1.html">Previous Lesson</a></b> |&nbsp; <b><a href="http://www.tinyos.net/tinyos-2.x/doc/html/tutorial/index.html">Top</a></b> &nbsp;|&nbsp; <b><a href="http://www.tinyos.net/tinyos-2.x/doc/html/tutorial/lesson3.html">Next Lesson </a>&nbsp;&gt;</b>
</p></center>


</body></html>